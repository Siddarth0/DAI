{% extends "adminDashboard/baseadmin.html" %}
{% load dashboard_tags %}

{% block title %}Manage {{ model_name|capfirst }}{% endblock %}

{% block content %}
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">Manage {{ model_name|capfirst }}</h1>
    <a href="{% url 'dashboard:model_add' model_name=model_name %}" 
       class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-150 text-sm">
      + Add {{ model_name|capfirst }}
    </a>
  </div>

  <!-- Sort Controls -->
  <div class="mb-4 flex justify-end space-x-2 text-sm">
    <span class="text-gray-600">Sort by:</span>
    <a href="?order_by=id" class="text-blue-600 hover:underline">Oldest</a>
    <a href="?order_by=-id" class="text-blue-600 hover:underline">Newest</a>
  </div>

  <div class="overflow-x-auto bg-white rounded shadow">
    <table class="min-w-full table-auto border-collapse">
      <thead>
        <tr class="bg-gray-100 text-left text-sm text-gray-700">
          <th class="border-b px-4 py-3 font-medium">SN</th>
          {% for field in fields %}
            <th class="border-b px-4 py-3 capitalize whitespace-nowrap font-medium">{{ field|snake_to_title }}</th>
          {% endfor %}
          {% if has_is_active %}
              <th class="border-b px-4 py-3 font-medium">Active</th>
          {% endif %}
          <th class="border-b px-4 py-3 font-medium">Actions</th>
        </tr>
      </thead>
      <tbody class="text-sm">
        {% for obj in objects %}
          <tr class="hover:bg-gray-50">
            <td class="border-t px-4 py-2 text-gray-800">{{ forloop.counter0|add:objects.start_index }}</td>

            {% for field in fields %}
              <td class="border-t px-4 py-2 text-gray-800">{{ obj|get_attr:field }}</td>
            {% endfor %}
          {% if has_is_active %}
            <td class="border-t px-4 py-2">
              {% if obj.is_active %}
                <span class="inline-block px-2 py-1 text-xs text-green-700 bg-green-100 rounded-full">Active</span>
              {% else %}
                <span class="inline-block px-2 py-1 text-xs text-red-700 bg-red-100 rounded-full">Inactive</span>
              {% endif %}
            </td>
          {% endif %}

            <td class="border-t px-4 py-2">
              <div class="flex space-x-2">
                <a href="{% url 'dashboard:model_edit' model_name=model_name pk=obj.pk %}" 
                   class="px-3 py-1 text-sm text-white bg-blue-600 rounded hover:bg-blue-700 transition">
                   Edit
                </a>
                 <button 
                   class="deleteBtn px-3 py-1 text-sm text-white bg-red-600 rounded hover:bg-red-700 transition"
                   data-id="{{ obj.pk }}"
                   data-name="{{ obj|get_attr:'name' }}"
                   data-delete-url="{% url 'dashboard:model_delete' model_name=model_name pk=obj.pk %}"
                   data-children-count="{{ obj.children.count|default:'0' }}"> 
                   Delete
                 </button>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="{{ fields|length|add:has_is_active|add:'2' }}" class="text-center px-6 py-4 text-gray-500">
              No {{ model_name }} entries found.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if objects.has_other_pages %}
    <div class="mt-6 flex items-center space-x-4 text-sm">
      {% if objects.has_previous %}
        <a href="?page={{ objects.previous_page_number }}" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">
          Previous
        </a>
      {% endif %}

      <span class="text-gray-700">Page {{ objects.number }} of {{ objects.paginator.num_pages }}</span>

      {% if objects.has_next %}
        <a href="?page={{ objects.next_page_number }}" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">
          Next
        </a>
      {% endif %}
    </div>
  {% endif %}


  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow-lg max-w-md w-full">
    <h3 class="text-lg font-semibold mb-4">Confirm Delete</h3>
    <p id="deleteMessage" class="mb-6 text-gray-700"></p>

    <form id="deleteForm" method="POST">
      {% csrf_token %}
      <div class="flex justify-end space-x-4">
        <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
      </div>
    </form>
  </div>
</div>


{% endblock %}
{% block scripts %}
<script>
  const modal = document.getElementById('deleteModal');
  const deleteForm = document.getElementById('deleteForm');
  const deleteMessage = document.getElementById('deleteMessage');
  const cancelBtn = document.getElementById('cancelBtn');

  document.querySelectorAll('.deleteBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const itemName = btn.dataset.name || 'this item';
      const childrenCount = parseInt(btn.dataset.childrenCount) || 0;
      const deleteUrl = btn.dataset.deleteUrl;

      let message = `Are you sure you want to delete "${itemName}"?`;
      if(childrenCount > 0){
        message += ` This will move ${childrenCount} child(ren) to "Others".`;
      }

      deleteMessage.textContent = message;
      deleteForm.action = deleteUrl;

      modal.classList.remove('hidden');
    });
  });

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
    }
  });
</script>
{% endblock %}

