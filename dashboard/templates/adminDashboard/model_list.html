{% extends "adminDashboard/baseadmin.html" %}
{% load dashboard_tags %}
{% load static %}

{% block title %}Manage {{ model_name|snake_to_title }}{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-3xl font-extrabold text-gray-900">Manage {{ model_name|snake_to_title }}</h1>
  <a href="{% url 'dashboard:model_add' model_name=model_name %}"
     class="inline-block px-5 py-2 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 transition">
    + Add {{ model_name|snake_to_title }}
  </a>
</div>

<div class="mb-4 flex justify-end space-x-4 text-sm text-gray-600">
  <span>Sort by:</span>
  <a href="?order_by=id" class="text-blue-600 hover:underline">Oldest</a>
  <a href="?order_by=-id" class="text-blue-600 hover:underline">Newest</a>
</div>

<div class="overflow-x-auto bg-white rounded-lg shadow border border-gray-200">
  <table class="min-w-full table-auto border-collapse text-gray-800">
    <thead>
      <tr class="bg-gray-100 text-left text-sm font-semibold text-gray-700 select-none">
        <th class="border-b border-gray-300 px-4 py-3 w-12">S.N</th>
        {% for field in fields %}
          <th class="border-b border-gray-300 px-4 py-3 capitalize whitespace-nowrap">{{ field|snake_to_title }}</th>
        {% endfor %}
        {% if has_is_active %}
          <th class="border-b border-gray-300 px-4 py-3 w-20">Active</th>
        {% endif %}
        <th class="border-b border-gray-300 px-4 py-3 w-36">Actions</th>
      </tr>
    </thead>
    <tbody class="text-sm">
      {% for obj in objects %}
      <tr class="hover:bg-blue-50 cursor-pointer">
        <td class="border-t border-gray-200 px-4 py-2 font-medium">{{ forloop.counter0|add:objects.start_index }}</td>

        {% for field in fields %}
          {% with value=obj|get_attr:field %}
            <td class="border-t border-gray-200 px-4 py-2 max-w-xs truncate" title="{% if value %}{% if field == 'content' %}{{ value|striptags }}{% else %}{{ value }}{% endif %}{% endif %}">
              {% if value %}
                {% if value.url %}
                  {% if value|is_image_extension %}
                    <img src="{{ value.url }}" alt="{{ obj }}" class="inline-block h-8 w-8 rounded object-cover shadow" />
                  {% elif value|file_extension == ".pdf" %}
                    <a href="{{ value.url }}" target="_blank" class="text-blue-600 underline hover:text-blue-800">
                      ðŸ“„ PDF Preview
                    </a>
                  {% else %}
                    <a href="{{ value.url }}" target="_blank" class="text-blue-600 underline hover:text-blue-800">
                      File
                    </a>
                  {% endif %}
                {% else %}
                  {% if field == 'content' %}
                    {{ value|striptags|truncatechars:70 }}
                  {% else %}
                    {% if value|stringformat:"s"|length > 70 %}
                      {{ value|stringformat:"s"|truncatechars:70 }}
                    {% else %}
                      {{ value }}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% else %}
                <span class="text-gray-300 italic">â€”</span>
              {% endif %}
            </td>
          {% endwith %}
        {% endfor %}

        {% if has_is_active %}
          <td class="border-t border-gray-200 px-4 py-2 text-center">
            {% if obj.is_active %}
              <span class="inline-block px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">Active</span>
            {% else %}
              <span class="inline-block px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">Inactive</span>
            {% endif %}
          </td>
        {% endif %}

        <td class="border-t border-gray-200 px-4 py-2">
          <div class="flex space-x-2">
            <a href="{% url 'dashboard:model_edit' model_name=model_name pk=obj.pk %}"
               class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm font-semibold">
               Edit
            </a>
            <button 
               class="deleteBtn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm font-semibold"
               data-id="{{ obj.pk }}"
               data-name="{{ obj|get_attr:'name' }}"
               data-delete-url="{% url 'dashboard:model_delete' model_name=model_name pk=obj.pk %}"
               data-children-count="{{ obj.children.count|default:'0' }}"> 
               Delete
             </button>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="{{ fields|length|add:has_is_active|add:'2' }}" class="text-center px-6 py-4 text-gray-500">
          No {{ model_name|snake_to_title }} entries found.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if objects.has_other_pages %}
<div class="mt-6 flex items-center justify-center space-x-4 text-sm text-gray-700">
  {% if objects.has_previous %}
    <a href="?page={{ objects.previous_page_number }}" class="px-4 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">Previous</a>
  {% endif %}
  <span>Page {{ objects.number }} of {{ objects.paginator.num_pages }}</span>
  {% if objects.has_next %}
    <a href="?page={{ objects.next_page_number }}" class="px-4 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">Next</a>
  {% endif %}
</div>
{% endif %}

<!-- Delete Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow-lg max-w-md w-full">
    <h3 class="text-lg font-semibold mb-4">Confirm Delete</h3>
    <p id="deleteMessage" class="mb-6 text-gray-700"></p>

    <form id="deleteForm" method="POST">
      {% csrf_token %}
      <div class="flex justify-end space-x-4">
        <button type="button" id="cancelBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const modal = document.getElementById('deleteModal');
  const deleteForm = document.getElementById('deleteForm');
  const deleteMessage = document.getElementById('deleteMessage');
  const cancelBtn = document.getElementById('cancelBtn');

  document.querySelectorAll('.deleteBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const itemName = btn.dataset.name || 'this item';
      const childrenCount = parseInt(btn.dataset.childrenCount) || 0;
      const deleteUrl = btn.dataset.deleteUrl;

      let message = `Are you sure you want to delete "${itemName}"?`;
      if(childrenCount > 0){
        message += ` This will move ${childrenCount} child(ren) to "Others".`;
      }

      deleteMessage.textContent = message;
      deleteForm.action = deleteUrl;

      modal.classList.remove('hidden');
    });
  });

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  window.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
    }
  });
</script>
{% endblock %}
